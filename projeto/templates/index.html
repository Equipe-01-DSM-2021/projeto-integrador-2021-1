<!DOCTYPE html>
<html>
  <head lang="pt-BR">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Mukta:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    
    <link href="../static/css/main.css" rel="stylesheet" />
    <link href="../static/css/menu.css" rel="stylesheet" />
    <link href="../static/css/modal.css" rel="stylesheet" />
    <link href="../static/css/search-options.css" rel="stylesheet" />
    <link href="../static/css/index.css" rel="stylesheet" />
    <link href="../static/css/cards.css" rel="stylesheet" />
    <script src="../static/js/jquery-3.6.0.min.js"></script>
    <script src="../static/js/modals.js"></script>

    <title>Análise de Dados Eleitorais</title>
    <link rel="shortcut icon" href="../static/img/favicon.ico" />
  </head>

  <body>
    <header>
      <!-- Título da Página -->
      <div id="logo">
        <img src="../static/img/icon-logo.svg" alt="Logo - Eleitorado.com" />
        <h1>Análise de Dados Eleitorais</h1>
      </div>

      <nav id="navigation">
        <a id="start" href="/">Início</a>
        <a id="project" href="/project">Sobre o projeto</a>
        <a id="us" href="/about-us">Sobre nós</a>
      </nav>
    </header>

    <main>
      <!--tipo de pesquisa-->
      <div id="search-by">
        <div id="search-by-city">
          <a class="search-by-link" href="#">Pesquisa por cidades</a>
        </div>
        <div id="search-by-region">
          <a class="search-by-link" href="/search-region">Comparação de regiões</a>
        </div>
      </div>

      <!--realizar pesquisas-->
      <div id="search-action">
          <h2>Faça uma pesquisa:</h2>
      </div>
      <div id="search-all">
        <!-- Menu de busca -->
        <div class="search">
          <form id="form-search" action="/" method="GET">
            <div class="input-group">
              <!-- Filtro de cidade -->
              <div class="filter">
                <label for="city">Cidade:</label>
                <select name="city" id="city">
                  <option selected disabled value="default"></option>
                  <!-- Cidades do Vale do Paraíba -->
                  <option value="Aparecida">Aparecida</option>
                  <option value="Caçapava">Caçapava</option>
                  <option value="Cachoeira Paulista">Cachoeira Paulista</option>
                  <option value="Canas">Canas</option>
                  <option value="Cunha">Cunha</option>
                  <option value="Guaratinguetá">Guaratinguetá</option>
                  <option value="Igaratá">Igaratá</option>
                  <option value="Jacareí">Jacareí</option>
                  <option value="Jambeiro">Jambeiro</option>
                  <option value="Lagoinha">Lagoinha</option>
                  <option value="Lorena">Lorena</option>
                  <option value="Natividade da Serra">
                    Natividade da Serra
                  </option>
                  <option value="Paraibuna">Paraibuna</option>
                  <option value="Pindamonhangaba">Pindamonhangaba</option>
                  <option value="Piquete">Piquete</option>
                  <option value="Potim">Potim</option>
                  <option value="Redenção da Serra">Redenção da Serra</option>
                  <option value="Roseira">Roseira</option>
                  <option value="Santa Branca">Santa Branca</option>
                  <option value="São José dos Campos">
                    São José dos Campos
                  </option>
                  <option value="São Luís do Paraitinga">
                    São Luís do Paraitinga
                  </option>
                  <option value="Taubaté">Taubaté</option>
                  <option value="Tremembé">Tremembé</option>
                  <!-- Cidades do Vale Histórico -->
                  <option value="Arapeí">Arapeí</option>
                  <option value="Areias">Areias</option>
                  <option value="Bananal">Bananal</option>
                  <option value="Cruzeiro">Cruzeiro</option>
                  <option value="Lavrinhas">Lavrinhas</option>
                  <option value="Queluz">Queluz</option>
                  <option value="São José do Barreiro">
                    São José do Barreiro
                  </option>
                  <option value="Silveiras">Silveiras</option>
                  <!-- Cidades do Litoral Norte -->
                  <option value="Caraguatatuba">Caraguatatuba</option>
                  <option value="Ilhabela">Ilhabela</option>
                  <option value="São Sebastião">São Sebastião</option>
                  <option value="Ubatuba">Ubatuba</option>
                  <!-- Cidades do Serra da Mantiqueira -->
                  <option value="Campos do Jordão">Campos do Jordão</option>
                  <option value="Monteiro Lobato">Monteiro Lobato</option>
                  <option value="Santo Antônio do Pinhal">
                    Santo Antônio do Pinhal
                  </option>
                  <option value="São Bento do Sapucaí">
                    São Bento do Sapucaí
                  </option>
                  <!-- Cidades do Região Bragantina -->
                  <option value="Atibaia">Atibaia</option>
                  <option value="Bom Jesus dos Perdões">
                    Bom Jesus dos Perdões
                  </option>
                  <option value="Bragança Paulista">Bragança Paulista</option>
                  <option value="Joanópolis">Joanópolis</option>
                  <option value="Nazaré Paulista">Nazaré Paulista</option>
                  <option value="Piracaia">Piracaia</option>
                  <option value="Vargem">Vargem</option>
                </select>
              </div>

              <!-- Filtro de cargo -->
              <div class="filter">
                <label for="role">Cargo:</label>
                <select name="role" id="role">
                  <option selected disabled value="default"></option>
                  <option value="presidente">Presidente</option>
                  <option value="governador">Governador</option>
                  <option value="prefeito">Prefeito</option>
                </select>
              </div>

              <!-- Filtro de ano -->
              <div class="filter">
                <label for="year">Ano:</label>
                <select name="year" id="year" disabled>
                  <option id='default' value="default" selected disabled>Selecione um cargo primeiro!</option>
                  <option id='year-vinte' value="2020">2020</option>
                  <option id='year-dezoito' value="2018">2018</option>
                  <option id='year-dezesseis' value="2016">2016</option>
                </select>
              </div>
            </div>
          </form>
        </div>
      
        <!-- Botões de limpar campos dos filtros e de enviar dados -->
        <div class="button-group">
          <button onclick="clearFilters()">
            <img src="../static/img/icon-clear.svg" />
          </button>
          <button
            id="search"
            type="submit"
            title="Pesquisar"
            onclick="enableCards()"
          >
            <img src="../static/img/icon-search.svg" />
          </button>
        </div>
      </div>

      <!-- Exibição dos cards com o resultado da busca -->
      <div id="search-result">
        <p>Selecione os filtros e realize uma pesquisa!</p>
      </div>
    </main>

    <!-- Modal de zoom em gráficos-->
    <div class="modal-overlay">
      <div class="modal-container-zoom">
          <div class="modal-header">
            <h2 id="chartTitle">Titulo do Gráfico</h2>
            <img
              id="close"
              src="../static/img/icon-close.png"
              alt="Fechar janela"
              onclick="Modal.toggleZoom()"
            />
          </div>

          <div class="zoom-graphic">
            <!-- Gráfico com zoom -->
            <div id="chart-zoom-container">
              <div class="graphic-zoom">   
                  <p id='canvas'></p>
                  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>  
              </div>
            </div>
            <!-- // Gráfico com zoom -->
          </div>
        </div>
      </div>
    </div>

    <!-- Script do Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

    <script type="text/javascript">

      // usando o jquery para filtrar os anos de acordo com os cargos selecionados
      $(document).ready(function () {
        $("#role").change(function(){ // 'change' identifica quando há mudanças no campo
          var searchRole = $(this).val(); // salva o valor do campo na variável searchRole

          switch (searchRole) {
            case 'default': // Não permite valores vazios
              $('#year').val("default").change();
              $('#year').attr('disabled','disabled');
              break;

            case 'presidente':
              // Configurações gerais
              $('#default').hide();
              $('#year').val("").change();
              $('#year').removeAttr('disabled');

              // Esconde anos que não terão esse tipo de eleição
              $('#year-vinte, #year-dezesseis').hide();

              // Exibe anos que terão esse tipo de eleição
              $('#year-dezoito').show();
              break;

            case 'prefeito':
              // Configurações gerais
              $('#default').hide();
              $('#year').val("").change();
              $('#year').removeAttr('disabled');

              // Esconde anos que não terão esse tipo de eleição
              $('#year-dezoito').hide();

              // Exibe anos que terão esse tipo de eleição
              $('#year-vinte, #year-dezesseis').show();
              break;

            case 'governador':
              // Configurações gerais
              $('#default').hide();
              $('#year').val("").change();
              $('#year').removeAttr('disabled');

              // Esconde anos que não terão esse tipo de eleição
              $('#year-vinte, #year-dezesseis').hide();

              // Exibe anos que terão esse tipo de eleição
              $('#year-dezoito').show();
              break;

          }
        });
      });

      // variáveis globais
      function global() {
        var dataKeys = []; // Dados para zoom
        var dataValues = []; // Dados para zoom
        var dataAll = []; // Dados para exportação
      }

      // Função de limpar pesquisa
      function clearFilters() {
        // limpa filtros
        var form = document.getElementById("form-search");
        form.reset();

        // Limpa os cards
        results = document.getElementById("search-result");
        results.innerHTML = '<p>Selecione os filtros e realize uma pesquisa!</p>'
      }

      //ativa os cards
      function enableCards() {
        //capturando os valores dos campos da busca
        var cityField = document.querySelector("#city");
        var city = cityField.value;

        var yearField = document.querySelector("#year");
        var year = yearField.value;

        var roleField = document.querySelector("#role");
        var role = roleField.value;

        // Limpa o que tiver no lugar dis resultados
        results = document.getElementById("search-result");
        results.innerHTML = '<p>Aguarde, a sua busca está sendo feita!</p>'

        if (city == "default" || city == '' || year == 'default' || year == '' || role == 'default' || role == '') {
          alert('Por favor, preencha todos os campos!')
          results = document.getElementById("search-result");
          results.innerHTML = '<p>Selecione os filtros e realize uma pesquisa!</p>'
        } else {
          //gerando os gráficos com os dados recebidos por json
          $.ajax({
            url:
              "http://localhost:5000/data?city=" +
              city +
              "&year=" +
              year +
              "&role=" +
              role,
            dataType: "json",
            success: function (data) {
              //div para mostrar os cards
              phase = document.querySelector("#search-result p");
              phase.innerHTML = "";

              //recebendo o json
              results = document.getElementById("search-result");
              data = JSON.parse(data);

              // Definindo nome social
              data.cardNomeSocial.forEach(function(card){
                Object.keys(card).forEach(function(cardKey){
                  objNomeSocial = card[cardKey]
                })
              })
              nomeSocial = JSON.stringify(objNomeSocial)
              console.log(nomeSocial)

              // Definindo os dados dos candidatos
              dataCandidatos = []
              data.cardCandidato.forEach(function(card){
                Object.keys(card).forEach(function(cardKey){
                  dataCandidatos.push(card[cardKey]);
                })
              })
              console.log(dataCandidatos)

              //zerando variáveis globais
              global.dataKeys = [];
              global.dataValues = [];
              global.dataAll = [];

              // Inserindo o HTML do gráfico
              results.innerHTML = `
                <div class="result">
                  <div class="card">
                    <div class="graphic">
                      <div class="graphic-normal">
                        <!-- CANVAS DO GRÁFICO -->
                        <canvas id="chart-0" width="150px" height="140px"></canvas>
                      </div>
                    </div>
                    <div class="graphic-description">
                      <!-- DADOS DO GRÁFICO -->
                      <h2>Escolaridade</h2>
                      <a href="https://www.tse.jus.br/eleicoes/estatisticas/repositorio-de-dados-eleitorais-1/repositorio-de-dados-eleitorais" target="_blank">Dados do TSE</a>

                      <div class="icon-actions">
                        <!-- Ícone de zoom -->
                        <img
                          id="zoom"
                          src="../static/img/icon-zoom.svg"
                          alt="Aumentar gráfico"
                          onclick="Modal.toggleZoom(0, 'Quantidade de eleitores por grau de escolaridade', 'Quantidade de Eleitores', 'bar', 0)"
                        />
                        <!-- Ícone de download. Ao ser clicado: seleção do formato para download do resultado -->
                        <img
                          id="download"
                          src="../static/img/icon-download.svg"
                          alt="Baixar"
                          onclick="Modal.toggleDownload(0, 'grau-escolaridade')"
                        />
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="graphic">
                      <div class="graphic-normal">
                        <!-- CANVAS DO GRÁFICO -->
                        <canvas id="chart-1" width="150px" height="140px"></canvas>
                      </div>
                    </div>
                    <div class="graphic-description">
                      <!-- DADOS DO GRÁFICO -->
                      <h2>Estado civil</h2>
                      <a href="https://www.tse.jus.br/eleicoes/estatisticas/repositorio-de-dados-eleitorais-1/repositorio-de-dados-eleitorais" target="_blank">Dados do TSE</a>

                      <div class="icon-actions">
                        <!-- Ícone de zoom -->
                        <img
                          id="zoom"
                          src="../static/img/icon-zoom.svg"
                          alt="Aumentar gráfico"
                          onclick="Modal.toggleZoom(1, 'Quantidade de eleitores por estado civil', 'Quantidade de Eleitores', 'bar', 0);"
                        />
                        <!-- Ícone de download. Ao ser clicado: seleção do formato para download do resultado -->
                        <img
                          id="download"
                          src="../static/img/icon-download.svg"
                          alt="Baixar"
                          onclick="Modal.toggleDownload(1, 'estado-civil')"
                        />
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="graphic">
                      <div class="graphic-normal">
                        <!-- CANVAS DO GRÁFICO -->
                        <canvas id="chart-2" width="150px" height="140px"></canvas>
                      </div>
                    </div>
                    <div class="graphic-description">
                      <!-- DADOS DO GRÁFICO -->
                      <h2>Faixa etária</h2>
                      <a href="https://www.tse.jus.br/eleicoes/estatisticas/repositorio-de-dados-eleitorais-1/repositorio-de-dados-eleitorais" target="_blank">Dados do TSE</a>

                      <div class="icon-actions">
                        <!-- Ícone de zoom -->
                        <img
                          id="zoom"
                          src="../static/img/icon-zoom.svg"
                          alt="Aumentar gráfico"
                          onclick="Modal.toggleZoom(2, 'Quantidade de eleitores por faixa etária', 'Quantidade de Eleitores', 'bar', 0)"
                        />
                        <!-- Ícone de download. Ao ser clicado: seleção do formato para download do resultado -->
                        <img
                          id="download"
                          src="../static/img/icon-download.svg"
                          alt="Baixar"
                          onclick="Modal.toggleDownload(2, 'faixa-etaria')"
                        />
                      </div>
                    </div>
                  </div>

                  <div class="member">
                      <h5>Uso de nome social</h5>
                      <h6>` + nomeSocial + ` eleitores usaram nome social</h6>
                    <div class="icon-actions">
                      <a id="data" href="https://www.tse.jus.br/eleicoes/estatisticas/repositorio-de-dados-eleitorais-1/repositorio-de-dados-eleitorais" target="_blank">Dados do TSE</a>
                      <!-- Ícone de download. Ao ser clicado: seleção do formato para download do resultado -->
                      <img
                        id="download"
                        src="../static/img/icon-download.svg"
                        alt="Baixar"
                        onclick="Modal.toggleDownload(3, 'nome-social')"
                      />
                    </div>
                  </div>

                  <div class="member">
                      <h5>Representante eleito</h5>
                      <h6>Nome: `+ dataCandidatos[2] +` (`+ dataCandidatos[3] +`)</h6>
                      <h6>Ganhou a eleição no `+ dataCandidatos[0]+`o turno</h6>
                    <div class="icon-actions">
                      <a id="data" href="https://www.tse.jus.br/eleicoes/estatisticas/repositorio-de-dados-eleitorais-1/repositorio-de-dados-eleitorais" target="_blank">Dados do TSE</a>
                      <!-- Ícone de download. Ao ser clicado: seleção do formato para download do resultado -->
                      <img
                        id="download"
                        src="../static/img/icon-download.svg"
                        alt="Baixar"
                        onclick="Modal.toggleDownload(4, 'representante-eleito')"
                      />
                    </div>
                  </div>

                </div>
            `;
              
              //zerando o contador que define o
              contCanvas = 0;

              // GERANDO CARDS DO ELEITORADO 
              data.cards.forEach(function(card){
                Object.keys(card).forEach(function(cardKey){

                  Chart.defaults.global.defaultFontColor = "#ffff";
                  var ctx = document.getElementById("chart-" + contCanvas).getContext("2d");
                  var myChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                      labels: Object.keys(card[cardKey]),
                      datasets: [
                        {
                          data: Object.values(card[cardKey]),
                          backgroundColor: "rgba(154, 219, 249, 0.4)",
                          borderColor: "rgba(154, 219, 249)",
                          borderWidth: 1,
                          datalabels: {
                            align: '',
                            anchor: ''
                          }
                        },
                      ],
                    },
                    options: {
                      plugins: {
                        datalabels: {
                          color: '',
                          font: {},
                          formatter: {}
                        }
                      },
                      legend: {
                        display: false,
                      },
                      scales: {
                        yAxes: [
                          {
                            ticks: {
                              beginAtZero: true,
                            },
                          },
                        ],
                        xAxes: [
                          {
                            display: false,
                          },
                        ],
                      },
                    },
                  });

                  // Salvando os dados recebidos pelo back em variáveis globais
                  global.dataKeys.push(Object.keys(card[cardKey]));
                  global.dataValues.push(Object.values(card[cardKey]));
                  global.dataAll.push(card[cardKey]);

                  // Acrescentando 1 no contCanvas
                  contCanvas = contCanvas + 1;
                })
              });

              // Adicionando os dados do NOME SOCIAL na variável dataAll
              global.dataAll.push(data.cardNomeSocial[0]);

              // Adicionando os dados do CANDIDATO na variável dataAll
              global.dataAll.push(data.cardCandidato[0]);

              // verificando variáveis globais
              console.log(global.dataKeys)
              console.log(global.dataValues)
              console.log(global.dataAll)
            },
          });
        }
      }
    </script>
  </body>
</html>